<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netgame HTTP Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .game-area {
            border: 1px solid #ccc;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .reels {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        .reel {
            border: 1px solid #000;
            padding: 10px;
            min-width: 40px;
            text-align: center;
            font-size: 24px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        select {
            padding: 8px;
            margin: 5px;
            min-width: 200px;
        }
    </style>
</head>
<body>
    <h1>Netgame HTTP Client</h1>

    <div class="game-area">
        <div>
            <label for="gameSelect">Select Game:</label>
            <select id="gameSelect" onchange="selectGame()">
                <option value="">Loading games...</option>
            </select>
        </div>

        <h2>Game: <span id="gameName">-</span></h2>
        <div>Balance: $<span id="balance">1000.00</span></div>
        <div>Lines: <span id="lines">40</span></div>
        <div>Bet per Line: $<span id="betLine">0.01</span></div>

        <div class="reels" id="reels">
            <div class="reel" id="reel1">-</div>
            <div class="reel" id="reel2">-</div>
            <div class="reel" id="reel3">-</div>
            <div class="reel" id="reel4">-</div>
            <div class="reel" id="reel5">-</div>
        </div>

        <div>
            <button onclick="createSession()">Create Session</button>
            <button onclick="spin()">Spin</button>
        </div>
    </div>

    <div>
        <h3>Request Log</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        class GameClient {
            constructor() {
                this.baseUrl = 'http://localhost:3000';
                this.sessionId = null;
                this.userId = 'demo-user-' + Date.now();
                this.gameId = null;
                this.gameData = null;
                this.logElement = document.getElementById('log');
                this.gameSelect = document.getElementById('gameSelect');
            }

            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                this.logElement.innerHTML += `[${timestamp}] ${message}\n`;
                this.logElement.scrollTop = this.logElement.scrollHeight;
            }

            async loadGames() {
                try {
                    this.log('Loading available games...');
                    const response = await fetch(`${this.baseUrl}/api/games`);
                    const games = await response.json();

                    this.gameSelect.innerHTML = '<option value="">Select a game...</option>';
                    games.forEach(game => {
                        const option = document.createElement('option');
                        option.value = game.name;
                        option.textContent = `${game.title} (${game.name})`;
                        this.gameSelect.appendChild(option);
                    });

                    this.log(`Loaded ${games.length} games`);
                } catch (error) {
                    this.log('Error loading games: ' + error.message);
                }
            }

            selectGame() {
                const selectedGame = this.gameSelect.value;
                if (selectedGame) {
                    this.gameId = selectedGame;
                    document.getElementById('gameName').textContent = selectedGame;
                    this.log(`Selected game: ${selectedGame}`);
                }
            }

            async createSession() {
                if (!this.gameId) {
                    alert('Please select a game first');
                    return;
                }

                try {
                    this.log(`Creating session for game: ${this.gameId}`);
                    const response = await fetch(`${this.baseUrl}/game/${this.gameId}/session`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            userId: this.userId,
                            balance: 1000.00
                        })
                    });

                    const result = await response.json();
                    this.log('Session created: ' + JSON.stringify(result));

                    if (result.sessionId) {
                        this.sessionId = result.sessionId;
                        document.getElementById('balance').textContent = result.balance.toFixed(2);
                        this.log('Session ID: ' + this.sessionId);
                    }
                } catch (error) {
                    this.log('Error creating session: ' + error.message);
                }
            }

            async spin() {
                if (!this.sessionId) {
                    alert('Please create a session first');
                    return;
                }

                try {
                    this.log('Executing spin...');
                    const response = await fetch(`${this.baseUrl}/game/${this.gameId}/spin`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Session-ID': this.sessionId
                        },
                        body: JSON.stringify({
                            betAmount: 0.40, // 40 lines * 0.01
                            betLine: 0.01,
                            lines: 40,
                            linesId: this.generateLinesId(40)
                        })
                    });

                    const result = await response.json();
                    this.log('Spin result: ' + JSON.stringify(result));

                    if (result.spinResult) {
                        this.updateSpinResult(result.spinResult);
                        document.getElementById('balance').textContent = result.balance.toFixed(2);
                    }
                } catch (error) {
                    this.log('Error executing spin: ' + error.message);
                }
            }

            updateSpinResult(result) {
                // Update reels display
                if (result.rows) {
                    for (let i = 1; i <= 5; i++) {
                        const reelElement = document.getElementById('reel' + i);
                        if (result.rows[i-1]) {
                            reelElement.textContent = result.rows[i-1].join(' ');
                        }
                    }
                }

                this.log('Spin completed - Total Win: ' + (result.totalWin || 0));
            }

            generateLinesId(numLines) {
                // Generate standard 40-line paylines for Royal40FruitsNG
                const linesId = [];
                const linePatterns = [
                    [1,1,1,1,1], [2,2,2,2,2], [3,3,3,3,3], [4,4,4,4,4],
                    [1,2,3,2,1], [2,3,4,3,2], [3,2,1,2,3], [4,3,2,3,4],
                    [1,1,1,1,2], [2,2,2,2,1], [3,3,3,3,4], [4,4,4,4,3],
                    [1,2,2,2,2], [2,2,2,2,3], [3,3,3,3,2], [4,3,3,3,3],
                    [2,1,1,1,1], [2,3,3,3,3], [3,2,2,2,2], [3,4,4,4,4],
                    [1,1,1,2,3], [2,2,2,3,4], [3,3,3,2,1], [4,4,4,3,2],
                    [1,2,3,3,3], [2,3,4,4,4], [3,2,1,1,1], [4,3,2,2,2],
                    [1,1,2,1,1], [2,2,1,2,2], [3,3,4,3,3], [4,4,3,4,4],
                    [1,2,2,2,1], [2,2,3,2,2], [3,3,2,3,3], [4,3,3,3,4],
                    [2,1,1,1,2], [2,3,3,3,2], [3,2,2,2,3], [3,4,4,4,3]
                ];

                for (let i = 0; i < Math.min(numLines, linePatterns.length); i++) {
                    linesId.push(linePatterns[i]);
                }

                return linesId;
            }
        }

        // Initialize client and load games
        const gameClient = new GameClient();
        gameClient.loadGames();

        // Make functions global for button onclick
        window.createSession = () => gameClient.createSession();
        window.spin = () => gameClient.spin();
        window.selectGame = () => gameClient.selectGame();
    </script>
</body>
</html>